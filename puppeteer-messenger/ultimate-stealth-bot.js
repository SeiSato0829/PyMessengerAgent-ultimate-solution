/**
 * Ultimate Stealth Facebook Messenger Bot
 * ÊúÄÈ´ò„É¨„Éô„É´„ÅÆÊ§úÂá∫ÂõûÈÅøÊäÄË°ì„ÇíÂÆüË£Ö
 * 
 * ‚ö†Ô∏è Ë≠¶ÂëäÔºöÊïôËÇ≤ÁõÆÁöÑ„ÅÆ„Åø„ÄÇËá™Â∑±Ë≤¨‰ªª„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
 */

const puppeteer = require('puppeteer-extra');
const StealthPlugin = require('puppeteer-extra-plugin-stealth');
const AdblockerPlugin = require('puppeteer-extra-plugin-adblocker');
const AnonymizeUA = require('puppeteer-extra-plugin-anonymize-ua');
const fs = require('fs').promises;
const path = require('path');
const crypto = require('crypto');

// „Éó„É©„Ç∞„Ç§„É≥Ë®≠ÂÆö
puppeteer.use(StealthPlugin());
puppeteer.use(AdblockerPlugin({ blockTrackers: true }));
puppeteer.use(AnonymizeUA());

class UltimateStealthBot {
  constructor(config = {}) {
    this.config = {
      email: config.email || process.env.FB_EMAIL,
      password: config.password || process.env.FB_PASSWORD,
      headless: config.headless !== undefined ? config.headless : 'new', // Êñ∞„Åó„ÅÑ„Éò„ÉÉ„Éâ„É¨„Çπ„É¢„Éº„Éâ
      proxy: config.proxy,
      userAgent: config.userAgent || this.generateUserAgent(),
      viewport: config.viewport || this.generateViewport(),
      locale: config.locale || 'ja-JP',
      timezone: config.timezone || 'Asia/Tokyo',
      userDataDir: config.userDataDir || path.join(__dirname, 'chrome-profile-' + this.generateSessionId()),
      maxRetries: config.maxRetries || 3,
      sessionRotation: config.sessionRotation || true,
    };
    
    this.browser = null;
    this.page = null;
    this.sessionId = this.generateSessionId();
    this.fingerprint = this.generateFingerprint();
  }

  /**
   * „Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÁîüÊàê
   */
  generateSessionId() {
    return crypto.randomBytes(16).toString('hex');
  }

  /**
   * „Éá„Éê„Ç§„Çπ„Éï„Ç£„É≥„Ç¨„Éº„Éó„É™„É≥„Éà„ÇíÁîüÊàê
   */
  generateFingerprint() {
    return {
      canvas: Math.random().toString(36).substring(7),
      webgl: Math.random().toString(36).substring(7),
      audio: Math.random().toString(36).substring(7),
      fonts: this.generateFontList(),
    };
  }

  /**
   * „É™„Ç¢„É´„Å™UserAgent„ÇíÁîüÊàê
   */
  generateUserAgent() {
    const agents = [
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    ];
    return agents[Math.floor(Math.random() * agents.length)];
  }

  /**
   * „É™„Ç¢„É´„Å™„Éì„É•„Éº„Éù„Éº„Éà„ÇíÁîüÊàê
   */
  generateViewport() {
    const viewports = [
      { width: 1920, height: 1080 },
      { width: 1366, height: 768 },
      { width: 1440, height: 900 },
      { width: 1536, height: 864 },
      { width: 1600, height: 900 },
    ];
    return viewports[Math.floor(Math.random() * viewports.length)];
  }

  /**
   * „Éï„Ç©„É≥„Éà„É™„Çπ„Éà„ÇíÁîüÊàê
   */
  generateFontList() {
    const baseFonts = [
      'Arial', 'Verdana', 'Helvetica', 'Times New Roman',
      'Georgia', 'Courier New', 'Trebuchet MS'
    ];
    // „É©„É≥„ÉÄ„É†„Å´‰∏¶„Å≥Êõø„Åà
    return baseFonts.sort(() => Math.random() - 0.5);
  }

  /**
   * „Éñ„É©„Ç¶„Ç∂„ÇíËµ∑ÂãïÔºàÊúÄÈ´ò„É¨„Éô„É´„ÅÆÂÅΩË£ÖÔºâ
   */
  async launch() {
    console.log('üöÄ Ë∂Ö„Çπ„ÉÜ„É´„Çπ„É¢„Éº„Éâ„Åß„Éñ„É©„Ç¶„Ç∂Ëµ∑Âãï‰∏≠...');
    
    const args = [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-blink-features=AutomationControlled',
      '--disable-features=site-per-process',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--disable-gpu',
      `--window-size=${this.config.viewport.width},${this.config.viewport.height}`,
      '--window-position=0,0',
      '--start-maximized',
      '--disable-features=IsolateOrigins',
      '--disable-site-isolation-trials',
      '--disable-features=BlockInsecurePrivateNetworkRequests',
      '--disable-web-security',
      '--disable-features=CrossSiteDocumentBlockingIfIsolating',
      '--disable-features=CrossSiteDocumentBlockingAlways',
      '--disable-features=IsolateOrigins,site-per-process',
      '--flag-switches-begin',
      '--disable-site-isolation-trials',
      '--flag-switches-end',
      `--user-agent=${this.config.userAgent}`,
      '--disable-features=UserAgentClientHint',
      `--lang=${this.config.locale}`,
    ];

    // „Éó„É≠„Ç≠„Ç∑Ë®≠ÂÆö
    if (this.config.proxy) {
      args.push(`--proxy-server=${this.config.proxy}`);
    }

    // „Éñ„É©„Ç¶„Ç∂Ëµ∑Âãï„Ç™„Éó„Ç∑„Éß„É≥
    const options = {
      headless: this.config.headless,
      args,
      ignoreHTTPSErrors: true,
      defaultViewport: this.config.viewport,
      executablePath: puppeteer.executablePath(),
      userDataDir: this.config.userDataDir,
      devtools: false,
      ignoreDefaultArgs: [
        '--enable-automation',
        '--enable-blink-features=AutomationControlled',
      ],
    };

    this.browser = await puppeteer.launch(options);
    
    // ÂÖ®„Éö„Éº„Ç∏„Å´ÂØæ„Åó„Å¶ÂÅΩË£Ö„ÇíÈÅ©Áî®
    this.browser.on('targetcreated', async (target) => {
      const page = await target.page();
      if (page) {
        await this.applyEvasion(page);
      }
    });

    this.page = await this.browser.newPage();
    await this.applyEvasion(this.page);
    
    console.log('‚úÖ „Çπ„ÉÜ„É´„Çπ„Éñ„É©„Ç¶„Ç∂Ëµ∑ÂãïÂÆå‰∫Ü');
    return this.page;
  }

  /**
   * ÊúÄÈ´ò„É¨„Éô„É´„ÅÆÊ§úÂá∫ÂõûÈÅø„ÇíÈÅ©Áî®
   */
  async applyEvasion(page) {
    // WebDriver„ÇíÂÆåÂÖ®„Å´Èö†ËîΩ
    await page.evaluateOnNewDocument(() => {
      // WebDriverÂâäÈô§
      Object.defineProperty(navigator, 'webdriver', {
        get: () => false,
      });
      
      // ChromeÁâπÊúâ„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂÅΩË£Ö
      window.chrome = {
        app: {
          isInstalled: false,
          InstallState: {
            DISABLED: 'disabled',
            INSTALLED: 'installed',
            NOT_INSTALLED: 'not_installed'
          },
          RunningState: {
            CANNOT_RUN: 'cannot_run',
            READY_TO_RUN: 'ready_to_run',
            RUNNING: 'running'
          }
        },
        runtime: {
          OnInstalledReason: {
            CHROME_UPDATE: 'chrome_update',
            INSTALL: 'install',
            SHARED_MODULE_UPDATE: 'shared_module_update',
            UPDATE: 'update'
          },
          OnRestartRequiredReason: {
            APP_UPDATE: 'app_update',
            OS_UPDATE: 'os_update',
            PERIODIC: 'periodic'
          },
          PlatformArch: {
            ARM: 'arm',
            ARM64: 'arm64',
            MIPS: 'mips',
            MIPS64: 'mips64',
            X86_32: 'x86-32',
            X86_64: 'x86-64'
          },
          PlatformNaclArch: {
            ARM: 'arm',
            MIPS: 'mips',
            MIPS64: 'mips64',
            X86_32: 'x86-32',
            X86_64: 'x86-64'
          },
          PlatformOs: {
            ANDROID: 'android',
            CROS: 'cros',
            LINUX: 'linux',
            MAC: 'mac',
            OPENBSD: 'openbsd',
            WIN: 'win'
          },
          RequestUpdateCheckStatus: {
            NO_UPDATE: 'no_update',
            THROTTLED: 'throttled',
            UPDATE_AVAILABLE: 'update_available'
          },
          connect: () => {},
          sendMessage: () => {},
        },
        webstore: {
          install: () => {},
          onDownloadProgress: {},
          onInstallStageChanged: {},
        }
      };

      // Permissions APIÂÅΩË£Ö
      const originalQuery = window.navigator.permissions.query;
      window.navigator.permissions.query = (parameters) => (
        parameters.name === 'notifications' ?
          Promise.resolve({ state: Notification.permission }) :
          originalQuery(parameters)
      );

      // PluginÂÅΩË£Ö
      Object.defineProperty(navigator, 'plugins', {
        get: () => {
          return [
            { 
              0: { type: "application/x-google-chrome-pdf", suffixes: "pdf" },
              1: { type: "application/pdf", suffixes: "pdf" },
              description: "Portable Document Format",
              filename: "internal-pdf-viewer",
              length: 2,
              name: "Chrome PDF Plugin"
            },
            {
              0: { type: "application/x-nacl", suffixes: "" },
              1: { type: "application/x-pnacl", suffixes: "" },
              description: "Native Client Executable",
              filename: "internal-nacl-plugin",
              length: 2,
              name: "Native Client"
            }
          ];
        },
      });

      // LanguageÂÅΩË£Ö
      Object.defineProperty(navigator, 'languages', {
        get: () => ['ja-JP', 'ja', 'en-US', 'en'],
      });

      // Hardware ConcurrencyÂÅΩË£Ö
      Object.defineProperty(navigator, 'hardwareConcurrency', {
        get: () => 4 + Math.floor(Math.random() * 4),
      });

      // Device MemoryÂÅΩË£Ö
      Object.defineProperty(navigator, 'deviceMemory', {
        get: () => 8,
      });

      // ConnectionÂÅΩË£Ö
      Object.defineProperty(navigator, 'connection', {
        get: () => ({
          effectiveType: '4g',
          rtt: 100,
          downlink: 1.5,
          saveData: false,
        }),
      });

      // Battery APIÂÅΩË£Ö
      navigator.getBattery = () => Promise.resolve({
        charging: true,
        chargingTime: 0,
        dischargingTime: Infinity,
        level: 0.8 + Math.random() * 0.2,
      });

      // WebGLÂÅΩË£Ö
      const getParameter = WebGLRenderingContext.prototype.getParameter;
      WebGLRenderingContext.prototype.getParameter = function(parameter) {
        if (parameter === 37445) {
          return 'Intel Inc.';
        }
        if (parameter === 37446) {
          return 'Intel Iris OpenGL Engine';
        }
        return getParameter.apply(this, arguments);
      };

      // CanvasÂÅΩË£Ö
      const toDataURL = HTMLCanvasElement.prototype.toDataURL;
      HTMLCanvasElement.prototype.toDataURL = function() {
        const context = this.getContext('2d');
        const imageData = context.getImageData(0, 0, this.width, this.height);
        for (let i = 0; i < imageData.data.length; i += 4) {
          imageData.data[i] = imageData.data[i] ^ (Math.random() * 0.1);
        }
        context.putImageData(imageData, 0, 0);
        return toDataURL.apply(this, arguments);
      };

      // AudioContextÂÅΩË£Ö
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioContext = new AudioContext();
      const oscillator = audioContext.createOscillator();
      const analyser = audioContext.createAnalyser();
      const gain = audioContext.createGain();
      const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

      // TimezoneÂÅΩË£Ö
      Date.prototype.getTimezoneOffset = () => -540; // JST
    });

    // „Éû„Ç¶„ÇπÂãï‰Ωú„ÅÆ‰∫∫ÈñìÂåñ
    await this.humanizeMouseMovements(page);
    
    // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ„ÅÆ‰∫∫ÈñìÂåñ
    await this.humanizeKeyboard(page);

    // „Çπ„ÇØ„É≠„Éº„É´„ÅÆ‰∫∫ÈñìÂåñ
    await this.humanizeScrolling(page);
  }

  /**
   * „Éû„Ç¶„ÇπÂãï‰Ωú„Çí‰∫∫Èñì„Çâ„Åó„Åè„Åô„Çã
   */
  async humanizeMouseMovements(page) {
    page.on('mouse', async (x, y) => {
      // „Éô„Ç∏„ÇßÊõ≤Á∑ö„Çí‰Ωø„Å£„ÅüËá™ÁÑ∂„Å™„Éû„Ç¶„ÇπÁßªÂãï
      const steps = 20 + Math.floor(Math.random() * 10);
      for (let i = 0; i < steps; i++) {
        const t = i / steps;
        const easing = t < 0.5 
          ? 4 * t * t * t 
          : 1 - Math.pow(-2 * t + 2, 3) / 2;
        
        await page.mouse.move(
          x * easing,
          y * easing
        );
        
        await this.randomWait(5, 15);
      }
    });
  }

  /**
   * „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ„Çí‰∫∫Èñì„Çâ„Åó„Åè„Åô„Çã
   */
  async humanizeKeyboard(page) {
    const originalType = page.keyboard.type.bind(page.keyboard);
    page.keyboard.type = async (text, options = {}) => {
      const chars = text.split('');
      for (const char of chars) {
        // WPM: 40-80 (‰∫∫Èñì„ÅÆÂπ≥Âùá„Çø„Ç§„Éî„É≥„Ç∞ÈÄüÂ∫¶)
        const wpm = 40 + Math.random() * 40;
        const delay = 60000 / (wpm * 5); // 1ÊñáÂ≠ó„ÅÇ„Åü„Çä„ÅÆ„Éü„É™Áßí
        
        await originalType(char, { delay: delay + Math.random() * 50 });
        
        // ÊôÇ„ÄÖ‰∏ÄÊôÇÂÅúÊ≠¢ÔºàËÄÉ„Åà„Å¶„ÅÑ„ÇãÊßòÂ≠êÔºâ
        if (Math.random() < 0.05) {
          await this.randomWait(500, 2000);
        }
        
        // „Çø„Ç§„Éó„Éü„Çπ„Å®‰øÆÊ≠£Ôºà3%„ÅÆÁ¢∫ÁéáÔºâ
        if (Math.random() < 0.03) {
          const wrongChar = String.fromCharCode(97 + Math.floor(Math.random() * 26));
          await originalType(wrongChar, { delay: delay });
          await this.randomWait(200, 500);
          await page.keyboard.press('Backspace');
          await this.randomWait(100, 300);
        }
      }
    };
  }

  /**
   * „Çπ„ÇØ„É≠„Éº„É´„Çí‰∫∫Èñì„Çâ„Åó„Åè„Åô„Çã
   */
  async humanizeScrolling(page) {
    page.on('load', async () => {
      // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„ÄÅËá™ÁÑ∂„Å´„Çπ„ÇØ„É≠„Éº„É´
      const scrollHeight = await page.evaluate(() => document.body.scrollHeight);
      let currentPosition = 0;
      
      while (currentPosition < scrollHeight - 1000) {
        const scrollAmount = 100 + Math.random() * 300;
        await page.evaluate((amount) => {
          window.scrollBy({
            top: amount,
            behavior: 'smooth'
          });
        }, scrollAmount);
        
        currentPosition += scrollAmount;
        
        // Ë™≠„Çì„Åß„ÅÑ„ÇãÊôÇÈñì„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
        await this.randomWait(1000, 3000);
        
        // ÊôÇ„ÄÖ‰∏ä„Å´„ÇÇÂ∞ë„Åó„Çπ„ÇØ„É≠„Éº„É´
        if (Math.random() < 0.2) {
          await page.evaluate(() => {
            window.scrollBy({
              top: -(50 + Math.random() * 100),
              behavior: 'smooth'
            });
          });
          await this.randomWait(500, 1000);
        }
      }
    });
  }

  /**
   * È´òÂ∫¶„Å™„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÔºà2FAÂØæÂøúÔºâ
   */
  async login() {
    console.log('üîê È´òÂ∫¶„Å™„Çπ„ÉÜ„É´„Çπ„É≠„Ç∞„Ç§„É≥ÈñãÂßã...');
    
    // CookieË™≠„ÅøËæº„ÅøË©¶Ë°å
    const cookieLogin = await this.tryLoginWithCookies();
    if (cookieLogin) {
      console.log('‚úÖ CookieÁµåÁî±„Åß„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
      return true;
    }

    // ÈÄöÂ∏∏„É≠„Ç∞„Ç§„É≥
    await this.page.goto('https://www.facebook.com', {
      waitUntil: 'networkidle0',
      timeout: 60000
    });

    // „É©„É≥„ÉÄ„É†ÂæÖÊ©üÔºà„Éö„Éº„Ç∏Ë¶≥ÂØüÔºâ
    await this.randomWait(2000, 5000);

    // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂÖ•Âäõ
    const emailSelector = 'input[name="email"], input[id="email"]';
    await this.page.waitForSelector(emailSelector, { visible: true });
    await this.humanClick(emailSelector);
    await this.humanType(this.config.email);

    await this.randomWait(500, 1500);

    // „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ
    const passSelector = 'input[name="pass"], input[id="pass"]';
    await this.humanClick(passSelector);
    await this.humanType(this.config.password);

    await this.randomWait(1000, 2000);

    // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
    const loginButton = 'button[name="login"], button[type="submit"]';
    await this.humanClick(loginButton);

    // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂæÖÊ©ü
    try {
      await this.page.waitForNavigation({ 
        waitUntil: 'networkidle0', 
        timeout: 30000 
      });
    } catch (e) {
      console.log('„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂæÖÊ©ü„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºàÊ≠£Â∏∏„Å™Â†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ');
    }

    // 2FAÁ¢∫Ë™ç
    const has2FA = await this.check2FA();
    if (has2FA) {
      console.log('üì± 2ÊÆµÈöéË™çË®º„ÅåÂøÖË¶Å„Åß„Åô');
      // „Åì„Åì„Åß2FA„Ç≥„Éº„Éâ„ÇíÂæÖ„Å§ÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô
      return false;
    }

    // „É≠„Ç∞„Ç§„É≥ÊàêÂäüÁ¢∫Ë™ç
    const success = await this.verifyLogin();
    if (success) {
      await this.saveCookies();
      console.log('‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü');
    }

    return success;
  }

  /**
   * 2FAÁ¢∫Ë™ç
   */
  async check2FA() {
    const selectors = [
      'input[name="approvals_code"]',
      'input[aria-label*="code"]',
      'input[placeholder*="code"]'
    ];
    
    for (const selector of selectors) {
      const element = await this.page.$(selector);
      if (element) return true;
    }
    return false;
  }

  /**
   * ‰∫∫Èñì„Çâ„Åó„ÅÑ„ÇØ„É™„ÉÉ„ÇØ
   */
  async humanClick(selector) {
    const element = await this.page.$(selector);
    if (!element) throw new Error(`Element not found: ${selector}`);
    
    const box = await element.boundingBox();
    if (!box) throw new Error(`Element not visible: ${selector}`);
    
    // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Çí„ÇØ„É™„ÉÉ„ÇØ
    const x = box.x + box.width * (0.3 + Math.random() * 0.4);
    const y = box.y + box.height * (0.3 + Math.random() * 0.4);
    
    // „Éû„Ç¶„Çπ„ÇíÁßªÂãï
    await this.moveMouseNaturally(x, y);
    await this.randomWait(100, 300);
    
    // „ÇØ„É™„ÉÉ„ÇØ
    await this.page.mouse.click(x, y);
  }

  /**
   * Ëá™ÁÑ∂„Å™„Éû„Ç¶„ÇπÁßªÂãïÔºà„Éô„Ç∏„ÇßÊõ≤Á∑öÔºâ
   */
  async moveMouseNaturally(targetX, targetY) {
    const currentPosition = await this.page.evaluate(() => ({
      x: window.mouseX || 0,
      y: window.mouseY || 0
    }));
    
    const distance = Math.sqrt(
      Math.pow(targetX - currentPosition.x, 2) + 
      Math.pow(targetY - currentPosition.y, 2)
    );
    
    const steps = Math.min(25, Math.max(5, Math.floor(distance / 50)));
    
    for (let i = 0; i <= steps; i++) {
      const t = i / steps;
      const easing = t < 0.5 
        ? 4 * t * t * t 
        : 1 - Math.pow(-2 * t + 2, 3) / 2;
      
      const x = currentPosition.x + (targetX - currentPosition.x) * easing;
      const y = currentPosition.y + (targetY - currentPosition.y) * easing;
      
      // ÂæÆÂ¶ô„Å™Êè∫„Çå„ÇíËøΩÂä†
      const wobbleX = (Math.random() - 0.5) * 2;
      const wobbleY = (Math.random() - 0.5) * 2;
      
      await this.page.mouse.move(x + wobbleX, y + wobbleY);
      await this.randomWait(10, 30);
    }
    
    // ÊúÄÁµÇ‰ΩçÁΩÆ„Å´Ê≠£Á¢∫„Å´ÁßªÂãï
    await this.page.mouse.move(targetX, targetY);
  }

  /**
   * ‰∫∫Èñì„Çâ„Åó„ÅÑ„Çø„Ç§„Éî„É≥„Ç∞
   */
  async humanType(text) {
    for (const char of text) {
      await this.page.keyboard.type(char);
      
      // WPM: 40-80
      const wpm = 40 + Math.random() * 40;
      const delay = 60000 / (wpm * 5);
      
      await this.randomWait(delay, delay + 100);
      
      // ÊôÇ„ÄÖ„ÅÆ‰∏ÄÊôÇÂÅúÊ≠¢
      if (Math.random() < 0.05) {
        await this.randomWait(500, 1500);
      }
    }
  }

  /**
   * „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÔºàÊúÄÈ´ò„É¨„Éô„É´„ÅÆÂÅΩË£ÖÔºâ
   */
  async sendMessage(recipientName, message) {
    console.log(`üì§ ${recipientName}„Å∏„Çπ„ÉÜ„É´„ÇπÈÄÅ‰ø°ÈñãÂßã...`);
    
    try {
      // Messenger„Éö„Éº„Ç∏„Å∏ÁßªÂãï
      await this.page.goto('https://www.facebook.com/messages/t/', {
        waitUntil: 'networkidle0',
        timeout: 60000
      });

      await this.randomWait(3000, 5000);

      // Êñ∞Ë¶è„É°„ÉÉ„Çª„Éº„Ç∏„Éú„Çø„É≥„ÇíÊé¢„Åô
      const newMessageSelectors = [
        'div[aria-label*="Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏"]',
        'div[aria-label*="New message"]',
        'a[aria-label*="Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏"]',
        'svg[aria-label*="Êñ∞Ë¶è„É°„ÉÉ„Çª„Éº„Ç∏"]'
      ];

      let clicked = false;
      for (const selector of newMessageSelectors) {
        try {
          await this.page.waitForSelector(selector, { timeout: 5000 });
          await this.humanClick(selector);
          clicked = true;
          break;
        } catch (e) {
          continue;
        }
      }

      if (!clicked) {
        // ‰ª£ÊõøÊñπÊ≥ïÔºöÊ§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„ÇíÁõ¥Êé•‰ΩøÁî®
        const searchSelectors = [
          'input[placeholder*="Ê§úÁ¥¢"]',
          'input[placeholder*="Search"]',
          'input[aria-label*="Search"]'
        ];
        
        for (const selector of searchSelectors) {
          try {
            await this.page.waitForSelector(selector, { timeout: 5000 });
            await this.humanClick(selector);
            break;
          } catch (e) {
            continue;
          }
        }
      }

      await this.randomWait(1000, 2000);

      // Âèó‰ø°ËÄÖÂêç„ÇíÂÖ•Âäõ
      await this.humanType(recipientName);
      await this.randomWait(2000, 3000);

      // Ê§úÁ¥¢ÁµêÊûú„ÇíÈÅ∏Êäû
      await this.page.keyboard.press('ArrowDown');
      await this.randomWait(500, 1000);
      await this.page.keyboard.press('Enter');
      await this.randomWait(2000, 3000);

      // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„ÇíÊé¢„Åô
      const messageSelectors = [
        'div[aria-label*="„É°„ÉÉ„Çª„Éº„Ç∏"]',
        'div[aria-label*="Message"]',
        'div[contenteditable="true"]',
        'textarea[placeholder*="„É°„ÉÉ„Çª„Éº„Ç∏"]'
      ];

      let messageBox = null;
      for (const selector of messageSelectors) {
        messageBox = await this.page.$(selector);
        if (messageBox) break;
      }

      if (!messageBox) {
        throw new Error('„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      }

      await this.humanClick(messageBox);
      await this.randomWait(500, 1000);

      // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ
      await this.humanType(message);
      await this.randomWait(1000, 2000);

      // ÈÄÅ‰ø°ÔºàEnterÔºâ
      await this.page.keyboard.press('Enter');

      console.log(`‚úÖ „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÂÆå‰∫Ü: ${recipientName}`);
      
      // ÈÄÅ‰ø°Âæå„ÅÆÂæÖÊ©üÔºàÈáçË¶ÅÔºâ
      await this.randomWait(5000, 10000);
      
      return true;

    } catch (error) {
      console.error(`‚ùå ÈÄÅ‰ø°Â§±Êïó: ${error.message}`);
      await this.takeDebugScreenshot('send-error');
      return false;
    }
  }

  /**
   * „Éá„Éê„ÉÉ„Ç∞„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà
   */
  async takeDebugScreenshot(name) {
    const filename = `debug-${name}-${Date.now()}.png`;
    await this.page.screenshot({ 
      path: path.join(__dirname, 'screenshots', filename),
      fullPage: true 
    });
    console.log(`üì∏ „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà‰øùÂ≠ò: ${filename}`);
  }

  /**
   * Cookie‰øùÂ≠ò
   */
  async saveCookies() {
    try {
      const cookies = await this.page.cookies();
      const cookiesPath = path.join(this.config.userDataDir, 'cookies.json');
      await fs.mkdir(path.dirname(cookiesPath), { recursive: true });
      await fs.writeFile(cookiesPath, JSON.stringify(cookies, null, 2));
      console.log('üç™ Cookie‰øùÂ≠òÊàêÂäü');
    } catch (error) {
      console.error('Cookie‰øùÂ≠ò„Ç®„É©„Éº:', error);
    }
  }

  /**
   * Cookie„Åß„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å
   */
  async tryLoginWithCookies() {
    try {
      const cookiesPath = path.join(this.config.userDataDir, 'cookies.json');
      const cookiesString = await fs.readFile(cookiesPath, 'utf8');
      const cookies = JSON.parse(cookiesString);
      
      await this.page.setCookie(...cookies);
      await this.page.goto('https://www.facebook.com', {
        waitUntil: 'networkidle0'
      });
      
      return await this.verifyLogin();
    } catch (error) {
      return false;
    }
  }

  /**
   * „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç
   */
  async verifyLogin() {
    const loggedInSelectors = [
      'div[aria-label="Account"]',
      'div[aria-label="„Ç¢„Ç´„Ç¶„É≥„Éà"]',
      'a[aria-label="Home"]',
      'a[aria-label="„Éõ„Éº„É†"]',
      'div[role="banner"]'
    ];
    
    for (const selector of loggedInSelectors) {
      const element = await this.page.$(selector);
      if (element) return true;
    }
    
    return false;
  }

  /**
   * „É©„É≥„ÉÄ„É†ÂæÖÊ©ü
   */
  async randomWait(min, max) {
    const delay = Math.floor(Math.random() * (max - min) + min);
    await new Promise(resolve => setTimeout(resolve, delay));
  }

  /**
   * „Éñ„É©„Ç¶„Ç∂ÁµÇ‰∫Ü
   */
  async close() {
    if (this.browser) {
      await this.browser.close();
      console.log('üëã „Éñ„É©„Ç¶„Ç∂ÁµÇ‰∫Ü');
    }
  }
}

module.exports = UltimateStealthBot;